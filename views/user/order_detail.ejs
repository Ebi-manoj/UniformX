
<style>
  .progress-line {
    height: 2px;
    background-color: #e5e7eb;
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    z-index: 0;
  }
  .progress-line-active {
    height: 2px;
    background-color: #000;
    position: absolute;
    top: 50%;
    left: 0;
    width: 0;
    z-index: 1;
    transition: width 0.3s ease;
  }
  .step-active, .step-completed {
    background-color: #000;
    color: white;
    border-color: #000;
  }
  .step-pending {
    background-color: white;
    color: #6b7280;
    border: 2px solid #e5e7eb;
  }
  body, .container {
    font-family: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  h1, h2, h3 {
    font-family: 'Playfair Display', 'Poppins', serif;
    font-weight: 600;
  }
  p, span, button {
    font-family: 'Poppins', sans-serif;
    font-weight: 400;
  }
  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    text-align: center;
  }
  .btn-cancel {
    background-color: #ef4444;
    color: white;
  }
  .btn-cancel:hover {
    background-color: #dc2626;
  }
</style>

<div class="container mx-auto px-4 py-8 max-w-6xl">
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-black">Order Tracking</h1>
    <p class="text-gray-600 mt-2">Track your order status and delivery information</p>
  </header>

  <!-- Order Items -->
  <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden">
    <% order.items.forEach((item, index) => { %>
      <div class="<%= index < order.items.length - 1 ? 'border-b border-gray-100' : '' %> p-6">
        <div class="flex flex-col md:flex-row gap-6">
          <div class="w-full md:w-24 h-24 rounded-lg overflow-hidden bg-gray-100 flex-shrink-0">
            <img src="<%= item.image || 'https://via.placeholder.com/96' %>" alt="<%= item.title %>" class="w-full h-full object-cover">
          </div>
          <div class="flex-grow">
            <h2 class="text-xl font-semibold text-black mb-2"><%= item.title %></h2>
            <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-600">
              <p>Size: <%= item.size || 'N/A' %></p>
              <p>Quantity: <%= item.quantity %></p>
              <p class="font-semibold">₹<%= item.price.toFixed(2) %></p>
            </div>
            <div class="mt-3 flex items-center gap-3">
              <span class="px-3 py-1 <%= item.status === 'DELIVERED' ? 'bg-green-500' : item.status === 'CANCELLED' ? 'bg-red-500' : 'bg-blue-500' %> text-white text-sm rounded-full">
                <%= item.status.charAt(0).toUpperCase() + item.status.slice(1).toLowerCase() %>
              </span>
              <span class="text-gray-600 text-sm">expected by <%= new Date(order.expectedDelivery || Date.now()).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' }) %></span>
            </div>
            <div class="mt-3 flex items-center gap-2">
              <span class="text-gray-600 text-sm">Payment Status:</span>
              <span class="px-3 py-1 <%= order.paymentStatus === 'COMPLETED' ? 'bg-green-500' : order.paymentStatus === 'FAILED' ? 'bg-red-500' : 'bg-black' %> text-white text-sm rounded-full">
                <%= order.paymentStatus %>
              </span>
            </div>
          </div>
        </div>

        <!-- Item Progress -->
        <div class="mt-10 mb-4 relative" data-item-index="<%= index %>">
          <div class="progress-line"></div>
          <div class="progress-line-active" id="progress-line-<%= index %>"></div>
          <div class="flex justify-between relative z-10">
            <% const steps = ['PROCESSING', 'PACKED', 'SHIPPED', 'DELIVERED', 'CANCELLED', 'RETURNED']; %>
            <% steps.forEach((step, stepIndex) => { %>
              <% const history = item.statusHistory ? item.statusHistory.find(h => h.status === step) : null; %>
              <div class="flex flex-col items-center">
                <div class="w-10 h-10 rounded-full flex items-center justify-center <%= item.status === step ? 'step-active' : history ? 'step-completed' : 'step-pending' %> mb-2">
                  <i class="fas <%= step === 'PROCESSING' ? 'fa-clock' : step === 'PACKED' ? 'fa-check' : step === 'SHIPPED' ? 'fa-box' : step === 'DELIVERED' ? 'fa-truck' : step === 'CANCELLED' ? 'fa-times' : 'fa-undo' %>"></i>
                </div>
                <span class="text-xs font-medium <%= item.status === step || history ? 'text-black' : 'text-gray-500' %>">
                  <%= step.charAt(0).toUpperCase() + step.slice(1).toLowerCase() %>
                </span>
                <span class="text-xs text-gray-500">
                  <%= history ? new Date(history.timestamp).toLocaleString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true }) : item.status === step ? new Date().toLocaleString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true }) : 'Pending' %>
                </span>
              </div>
            <% }) %>
          </div>
        </div>

        <% if (item.status === 'PROCESSING') { %>
          <div class="mt-6 flex justify-end">
            <button class="btn btn-cancel cancel-item" data-order-id="<%= order._id %>" data-item-id="<%= item._id || index %>">Cancel Item</button>
          </div>
        <% } %>
      </div>
    <% }) %>
  </div>

  <!-- Order Details Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Delivery Address -->
    <div class="bg-white rounded-xl shadow-sm p-6">
      <h2 class="text-xl font-semibold text-black mb-4">Delivery Address</h2>
      <div class="flex items-start gap-3">
        <i class="fas fa-home text-gray-400 mt-1"></i>
        <div>
          <h3 class="font-medium text-black"><%= order.shippingAddress.name %></h3>
          <p class="text-gray-600 mt-1">
            <%= order.shippingAddress.street_address %><br>
            <%= order.shippingAddress.district %>, <%= order.shippingAddress.state %><br>
            <%= order.shippingAddress.pincode %>, <%= order.shippingAddress.country %>
          </p>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="bg-white rounded-xl shadow-sm p-6">
      <h2 class="text-xl font-semibold text-black mb-4">Order Summary</h2>
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-gray-600">Subtotal</span>
          <span class="font-medium">₹<%= order.subtotal.toFixed(2) %></span>
        </div>
        <div class="flex justify-between text-green-600">
          <span>Discount</span>
          <span>- ₹<%= order.discount ? order.discount.toFixed(2) : '0.00' %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Tax</span>
          <span class="font-medium">₹<%= order.taxAmount || 0 %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Shipping</span>
          <span class="font-medium">₹<%= order.shippingCost || 0 %></span>
        </div>
        <div class="pt-3 border-t border-gray-100 flex justify-between">
          <span class="font-semibold text-black">Total</span>
          <span class="font-semibold text-black">₹<%= order.totalAmount.toFixed(2) %></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Dynamically set progress bar width for each item
    const steps = ['PROCESSING', 'PACKED', 'SHIPPED', 'DELIVERED', 'CANCELLED', 'RETURNED'];
    <% order.items.forEach((item, index) => { %>
      const stepIndex<%= index %> = steps.indexOf('<%= item.status %>');
      const progressPercentage<%= index %> = stepIndex<%= index %> >= 0 ? ((stepIndex<%= index %> + 1) / steps.length) * 100 : 0;
      document.getElementById('progress-line-<%= index %>').style.width = `${progressPercentage<%= index %>}%`;
    <% }) %>

    // Cancel item handler
    document.querySelectorAll('.cancel-item').forEach(button => {
      button.addEventListener('click', async () => {
        const orderId = button.dataset.orderId;
        const itemId = button.dataset.itemId;
        if (confirm('Are you sure you want to cancel this item?')) {
          try {
            const response = await fetch(`/orders/cancel/${orderId}/item/${itemId}`, { method: 'POST' });
            const result = await response.json();
            if (result.success) {
              window.location.reload();
            } else {
              alert(result.message);
            }
          } catch (err) {
            alert('Error cancelling item');
          }
        }
      });
    });
  });
</script>
